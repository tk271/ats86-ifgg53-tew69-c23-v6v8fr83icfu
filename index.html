<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問題集</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 16px;
            color: #333;
            background-color: #f5f5f7;
        }
        h1 {
            text-align: center;
            color: #0070c9;
            margin-bottom: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom: 2px solid #0070c9;
            color: #0070c9;
            font-weight: bold;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .question {
            margin-bottom: 20px;
            font-size: 18px;
        }
        .option {
            margin: 8px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .option:hover {
            background-color: #e0e0e0;
        }
        .option.selected {
            background-color: #0070c9;
            color: white;
        }
        .option.correct {
            background-color: #4CAF50;
            color: white;
        }
        .option.incorrect {
            background-color: #f44336;
            color: white;
        }
        .explanation {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 8px;
            display: none;
        }
        button {
            background-color: #0070c9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background-color: #00569c;
        }
        textarea {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .progress {
            margin-bottom: 20px;
            text-align: right;
            color: #666;
        }
        .edit-buttons {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .option-container {
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .option-row {
            display: flex;
            margin-bottom: 5px;
        }
        .option-row input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
        }
        .remove-option {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
        }
        .add-option {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            margin-top: 5px;
        }
        .checkbox-container {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CompTIA Project+ 問題集</h1>
        
        <div class="tab-container">
            <div class="tab active" onclick="showTab('practice')">学習モード</div>
            <div class="tab" onclick="showTab('edit')">問題管理</div>
            <div class="tab" onclick="showTab('import-export')">インポート/エクスポート</div>
        </div>
        
        <div id="practice" class="content active">
            <div class="progress">
                <span id="question-number">問題 0/0</span>
            </div>
            <div id="question-text" class="question"></div>
            <div id="options-container"></div>
            <div id="explanation" class="explanation"></div>
            <div class="actions">
                <button id="check-answer" onclick="checkAnswer()">答え合わせ</button>
                <button id="dont-know" onclick="dontKnow()">わからない</button>
                <button id="next-question" onclick="nextQuestion()" style="display: none;">次の問題</button>
            </div>
        </div>
        
        <div id="edit" class="content">
            <div class="edit-buttons">
                <button onclick="showAddQuestionModal()">問題を追加</button>
            </div>
            <table id="questions-table">
                <thead>
                    <tr>
                        <th>問題</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="questions-table-body"></tbody>
            </table>
        </div>
        
        <div id="import-export" class="content">
            <h2>CSVインポート/エクスポート</h2>
            <p>CSVフォーマット: 問題,選択肢1|選択肢2|選択肢3,正解(0-indexed),解説,複数選択(true/false)</p>
            <button onclick="exportToCSV()">CSVエクスポート</button>
            <div style="margin-top: 20px;">
                <h3>CSVインポート</h3>
                <textarea id="csv-import" placeholder="CSVデータを貼り付けてください"></textarea>
                <button onclick="importFromCSV()">インポート</button>
            </div>
        </div>
    </div>
    
    <!-- 問題追加/編集モーダル -->
    <div id="question-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">問題を追加</h2>
            <input type="hidden" id="question-id">
            
            <label for="question-text-input">問題</label>
            <textarea id="question-text-input" style="height: 100px;"></textarea>
            
            <label>選択肢</label>
            <div id="options-input-container" class="option-container"></div>
            <button class="add-option" onclick="addOptionInput()">選択肢を追加</button>
            
            <div class="checkbox-container">
                <input type="checkbox" id="multiple-choice">
                <label for="multiple-choice" style="display: inline;">複数選択問題</label>
            </div>
            
            <label for="explanation-input">解説</label>
            <textarea id="explanation-input" style="height: 100px;"></textarea>
            
            <div class="actions">
                <button onclick="saveQuestion()">保存</button>
                <button onclick="closeModal()" style="background-color: #999;">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // データ構造
        let questions = [];
        let currentQuestionIndex = 0;
        let selectedOptions = [];
        let answerChecked = false;
        
        // 初期化
        window.onload = function() {
            loadQuestions();
            renderQuestionsList();
            if (questions.length > 0) {
                showQuestion(0);
            }
        };
        
        // ローカルストレージから問題を読み込む
        function loadQuestions() {
            const savedQuestions = localStorage.getItem('comptia-questions');
            if (savedQuestions) {
                questions = JSON.parse(savedQuestions);
            } else {
                // サンプル問題
                questions = [
                    {
                        question: "プロジェクト計画のどの部分がスコープクリープを防ぐのに役立ちますか？",
                        options: ["変更管理計画", "リスク管理計画", "品質管理計画", "コミュニケーション計画"],
                        correctAnswers: [0],
                        explanation: "変更管理計画はスコープクリープを防ぐために重要です。変更要求を適切に評価し、管理するプロセスを定義します。",
                        multipleChoice: false
                    },
                    {
                        question: "アジャイル開発手法の特徴はどれですか？（該当するものをすべて選択）",
                        options: ["反復的な開発サイクル", "詳細な事前計画", "頻繁な顧客フィードバック", "包括的なドキュメント"],
                        correctAnswers: [0, 2],
                        explanation: "アジャイル開発は反復的なサイクルと頻繁な顧客フィードバックを重視します。詳細な事前計画や包括的なドキュメントよりも、動くソフトウェアと顧客との協力を優先します。",
                        multipleChoice: true
                    }
                ];
                saveQuestions();
            }
        }
        
        // 問題をローカルストレージに保存
        function saveQuestions() {
            localStorage.setItem('comptia-questions', JSON.stringify(questions));
        }
        
        // タブの切り替え
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'edit') {
                renderQuestionsList();
            }
        }
        
        // 問題を表示
        function showQuestion(index) {
            if (questions.length === 0) {
                document.getElementById('question-text').innerHTML = "問題が登録されていません。問題管理タブから問題を追加してください。";
                document.getElementById('options-container').innerHTML = "";
                document.getElementById('question-number').textContent = "問題 0/0";
                return;
            }
            
            currentQuestionIndex = index;
            const question = questions[index];
            
            document.getElementById('question-text').innerHTML = question.question;
            document.getElementById('question-number').textContent = `問題 ${index + 1}/${questions.length}`;
            
            // 選択肢をランダムに並べ替え
            const shuffledOptions = [...question.options];
            const originalIndices = shuffledOptions.map((_, i) => i);
            
            // Fisher-Yatesシャッフルアルゴリズム
            for (let i = shuffledOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
                [originalIndices[i], originalIndices[j]] = [originalIndices[j], originalIndices[i]];
            }
            
            // 選択肢を表示
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = "";
            
            shuffledOptions.forEach((option, i) => {
                const optionEl = document.createElement('div');
                optionEl.className = 'option';
                optionEl.setAttribute('data-original-index', originalIndices[i]);
                optionEl.innerHTML = option;
                optionEl.onclick = function() {
                    if (answerChecked) return;
                    
                    const originalIndex = parseInt(this.getAttribute('data-original-index'));
                    
                    if (question.multipleChoice) {
                        // 複数選択の場合
                        if (selectedOptions.includes(originalIndex)) {
                            selectedOptions = selectedOptions.filter(idx => idx !== originalIndex);
                            this.classList.remove('selected');
                        } else {
                            selectedOptions.push(originalIndex);
                            this.classList.add('selected');
                        }
                    } else {
                        // 択一の場合
                        selectedOptions = [originalIndex];
                        document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                };
                optionsContainer.appendChild(optionEl);
            });
            
            // わからないボタンを表示
            const dontKnowOption = document.createElement('div');
            dontKnowOption.className = 'option';
            dontKnowOption.innerHTML = "わからない";
            dontKnowOption.onclick = function() {
                if (answerChecked) return;
                dontKnow();
            };
            optionsContainer.appendChild(dontKnowOption);
            
            // 状態をリセット
            document.getElementById('explanation').style.display = 'none';
            document.getElementById('check-answer').style.display = 'inline-block';
            document.getElementById('dont-know').style.display = 'inline-block';
            document.getElementById('next-question').style.display = 'none';
            answerChecked = false;
            selectedOptions = [];
        }
        
        // 答え合わせ
        function checkAnswer() {
            if (questions.length === 0) return;
            
            const question = questions[currentQuestionIndex];
            answerChecked = true;
            
            document.getElementById('explanation').innerHTML = question.explanation;
            document.getElementById('explanation').style.display = 'block';
            
            document.getElementById('check-answer').style.display = 'none';
            document.getElementById('dont-know').style.display = 'none';
            document.getElementById('next-question').style.display = 'inline-block';
            
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                if (option.innerHTML === "わからない") return;
                
                const originalIndex = parseInt(option.getAttribute('data-original-index'));
                
                if (question.correctAnswers.includes(originalIndex)) {
                    option.classList.add('correct');
                } else if (selectedOptions.includes(originalIndex)) {
                    option.classList.add('incorrect');
                }
            });
        }
        
        // わからない
        function dontKnow() {
            if (questions.length === 0) return;
            
            const question = questions[currentQuestionIndex];
            answerChecked = true;
            
            document.getElementById('explanation').innerHTML = question.explanation;
            document.getElementById('explanation').style.display = 'block';
            
            document.getElementById('check-answer').style.display = 'none';
            document.getElementById('dont-know').style.display = 'none';
            document.getElementById('next-question').style.display = 'inline-block';
            
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                if (option.innerHTML === "わからない") return;
                
                const originalIndex = parseInt(option.getAttribute('data-original-index'));
                
                if (question.correctAnswers.includes(originalIndex)) {
                    option.classList.add('correct');
                }
            });
        }
        
        // 次の問題へ
        function nextQuestion() {
            let nextIndex = currentQuestionIndex + 1;
            if (nextIndex >= questions.length) {
                nextIndex = 0;
            }
            showQuestion(nextIndex);
        }
        
        // 問題リストを表示
        function renderQuestionsList() {
            const tableBody = document.getElementById('questions-table-body');
            tableBody.innerHTML = "";
            
            questions.forEach((q, index) => {
                const row = document.createElement('tr');
                
                const questionCell = document.createElement('td');
                questionCell.textContent = q.question.length > 50 ? q.question.substring(0, 50) + "..." : q.question;
                row.appendChild(questionCell);
                
                const actionsCell = document.createElement('td');
                
                const editButton = document.createElement('button');
                editButton.textContent = "編集";
                editButton.onclick = function() { editQuestion(index); };
                actionsCell.appendChild(editButton);
                
                const deleteButton = document.createElement('button');
                deleteButton.textContent = "削除";
                deleteButton.style.backgroundColor = "#f44336";
                deleteButton.onclick = function() { deleteQuestion(index); };
                actionsCell.appendChild(deleteButton);
                
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }
        
        // 問題追加モーダルを表示
        function showAddQuestionModal() {
            document.getElementById('modal-title').textContent = "問題を追加";
            document.getElementById('question-id').value = "";
            document.getElementById('question-text-input').value = "";
            document.getElementById('explanation-input').value = "";
            document.getElementById('multiple-choice').checked = false;
            
            const optionsContainer = document.getElementById('options-input-container');
            optionsContainer.innerHTML = "";
            
            // デフォルトで4つの選択肢フィールドを追加
            for (let i = 0; i < 4; i++) {
                addOptionInput(null, i === 0);
            }
            
            document.getElementById('question-modal').style.display = 'block';
        }
        
        // 問題編集モーダルを表示
        function editQuestion(index) {
            const question = questions[index];
            
            document.getElementById('modal-title').textContent = "問題を編集";
            document.getElementById('question-id').value = index;
            document.getElementById('question-text-input').value = question.question;
            document.getElementById('explanation-input').value = question.explanation;
            document.getElementById('multiple-choice').checked = question.multipleChoice;
            
            const optionsContainer = document.getElementById('options-input-container');
            optionsContainer.innerHTML = "";
            
            question.options.forEach((option, i) => {
                addOptionInput(option, question.correctAnswers.includes(i));
            });
            
            document.getElementById('question-modal').style.display = 'block';
        }
        
        // 選択肢入力フィールドを追加
        function addOptionInput(optionText = null, isCorrect = false) {
            const optionsContainer = document.getElementById('options-input-container');
            const optionRow = document.createElement('div');
            optionRow.className = 'option-row';
            
            const optionInput = document.createElement('input');
            optionInput.type = 'text';
            optionInput.className = 'option-text';
            optionInput.placeholder = '選択肢';
            if (optionText !== null) {
                optionInput.value = optionText;
            }
            
            const correctCheckbox = document.createElement('input');
            correctCheckbox.type = 'checkbox';
            correctCheckbox.className = 'correct-option';
            correctCheckbox.checked = isCorrect;
            
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-option';
            removeButton.textContent = '削除';
            removeButton.onclick = function() {
                optionsContainer.removeChild(optionRow);
            };
            
            optionRow.appendChild(optionInput);
            optionRow.appendChild(correctCheckbox);
            optionRow.appendChild(removeButton);
            
            optionsContainer.appendChild(optionRow);
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        // 問題を保存
        function saveQuestion() {
            const questionId = document.getElementById('question-id').value;
            const questionText = document.getElementById('question-text-input').value.trim();
            const explanation = document.getElementById('explanation-input').value.trim();
            const multipleChoice = document.getElementById('multiple-choice').checked;
            
            if (!questionText) {
                alert('問題文を入力してください');
                return;
            }
            
            const optionRows = document.querySelectorAll('.option-row');
            const options = [];
            const correctAnswers = [];
            
            optionRows.forEach((row, index) => {
                const optionText = row.querySelector('.option-text').value.trim();
                const isCorrect = row.querySelector('.correct-option').checked;
                
                if (optionText) {
                    options.push(optionText);
                    if (isCorrect) {
                        correctAnswers.push(options.length - 1);
                    }
                }
            });
            
            if (options.length < 2) {
                alert('少なくとも2つの選択肢が必要です');
                return;
            }
            
            if (correctAnswers.length === 0) {
                alert('少なくとも1つの正解を選択してください');
                return;
            }
            
            if (!multipleChoice && correctAnswers.length > 1) {
                alert('択一問題では1つだけ正解を選択してください');
                return;
            }
            
            const newQuestion = {
                question: questionText,
                options: options,
                correctAnswers: correctAnswers,
                explanation: explanation,
                multipleChoice: multipleChoice
            };
            
            if (questionId === "") {
                // 新規追加
                questions.push(newQuestion);
            } else {
                // 編集
                questions[questionId] = newQuestion;
            }
            
            saveQuestions();
            renderQuestionsList();
            closeModal();
            
            // 現在表示している問題が編集されたらその問題を再表示
            if (questionId !== "" && parseInt(questionId) === currentQuestionIndex) {
                showQuestion(currentQuestionIndex);
            }
        }
        
        // 問題を削除
        function deleteQuestion(index) {
            if (confirm('この問題を削除してもよろしいですか？')) {
                questions.splice(index, 1);
                saveQuestions();
                renderQuestionsList();
                
                // 現在表示している問題が削除された場合は別の問題を表示
                if (index === currentQuestionIndex) {
                    if (questions.length > 0) {
                        showQuestion(Math.min(index, questions.length - 1));
                    } else {
                        showQuestion(0);
                    }
                } else if (index < currentQuestionIndex) {
                    // 削除された問題が現在の問題より前にある場合、インデックスを調整
                    currentQuestionIndex--;
                    document.getElementById('question-number').textContent = `問題 ${currentQuestionIndex + 1}/${questions.length}`;
                }
            }
        }
        
        // CSVエクスポート
        function exportToCSV() {
            let csv = 'question,options,correctAnswers,explanation,multipleChoice\n';
            
            questions.forEach(q => {
                const questionEscaped = q.question.replace(/"/g, '""');
                const optionsEscaped = q.options.map(opt => opt.replace(/\|/g, '\\|').replace(/"/g, '""')).join('|');
                const explanationEscaped = q.explanation.replace(/"/g, '""');
                const correctAnswers = q.correctAnswers.join('|');
                
                csv += `"${questionEscaped}","${optionsEscaped}","${correctAnswers}","${explanationEscaped}",${q.multipleChoice}\n`;
            });
            
            // CSVダウンロード
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'comptia-questions.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // CSVインポート
        function importFromCSV() {
            const csvText = document.getElementById('csv-import').value.trim();
            if (!csvText) {
                alert('CSVデータを入力してください');
                return;
            }
            
            try {
                const lines = csvText.split('\n');
                const header = lines[0].toLowerCase();
                
                if (!header.includes('question') || !header.includes('options')) {
                    throw new Error('CSVフォーマットが正しくありません');
                }
                
                const newQuestions = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    // CSVパース (引用符を考慮)
                    const values = [];
                    let insideQuotes = false;
                    let currentValue = '';
                    
                    for (let j = 0; j < lines[i].length; j++) {
                        const char = lines[i][j];
                        
                        if (char === '"') {
                            if (insideQuotes && j + 1 < lines[i].length && lines[i][j + 1] === '"') {
                                // エスケープされた引用符
                                currentValue += '"';
                                j++;
                            } else {
                                insideQuotes = !insideQuotes;
                            }
                        } else if (char === ',' && !insideQuotes) {
                            values.push(currentValue);
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    values.push(currentValue);
                    
                    if (values.length < 4) continue;
                    
                    const question = values[0];
                    const options = values[1].split('|').map(opt => opt.replace(/\\\|/g, '|'));
                    const correctAnswersStr = values[2];
                    const explanation = values[3] || '';
                    const multipleChoice = values[4] ? values[4].toLowerCase() === 'true' : false;
                    
                    let correctAnswers;
                    if (correctAnswersStr.includes('|')) {
                        correctAnswers = correctAnswersStr.split('|').map(idx => parseInt(idx));
                    } else {
                        correctAnswers = [parseInt(correctAnswersStr)];
                    }
                    
                    newQuestions.push({
                        question,
                        options,
                        correctAnswers,
                        explanation,
                        multipleChoice
                    });
                }
                
                if (newQuestions.length === 0) {
                    alert('インポートできる問題がありませんでした');
                    return;
                }
                
                if (confirm(`${newQuestions.length}問の問題をインポートします。既存の問題と置き換えますか？`)) {
                    questions = newQuestions;
                } else if (confirm('既存の問題に追加しますか？')) {
                    questions = questions.concat(newQuestions);
                } else {
                    return;
                }
                
                saveQuestions();
                renderQuestionsList();
                showQuestion(0);
                document.getElementById('csv-import').value = '';
                alert(`${newQuestions.length}問の問題をインポートしました`);
                
            } catch (e) {
                alert(`インポートエラー: ${e.message}`);
            }
        }
    </script>
</body>
</html>
